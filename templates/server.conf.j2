# Managed by Ansible

server {
    server_name {{item.server_name}};
    listen {{ item.listen_port }};
    #listen 443 ssl spdy;

    root {{ item.root_dir }}/{{ item.server_name }};
    #root /opt/misp-server/misp/app/webroot;
    index {{ item.index_name | default('index.html')}};
    index index.php;

    # Configure Crypto Keys/Certificates/DH
    {% if item.ssl is defined and item.ssl != None%}}
    certificate         {{ item.ssl.cert_dir}}/{{ item.ssl.crt | default('server.crt')}};
    certificate_key     {{ item.ssl.cert_dir}}/{{ item.ssl.key | default('server.key')}};
    {% endif %}}

    {% if security_headers is defined and security_headrers != None %}}
    # enable HSTS
    add_header {{ item.security_headers.transport_security }};
    add_header {{ item.security_headers.xframe_options }};
    {% endif %}}

    location / {
        try_files {{ item.try_files }};
    }
    {% if fastcgi_php is defined and fastcgi_php != None %}}
    location ~ \.php$ {
        {{ item.fastcgi_php.fastcgi_split_path_info }};
        {{ item.fastcgi_php.fastcgi_pass }};
        {{ item.fastcgi_php.fastcgi_index }};
        {{ item.fastcgi_php.include_fastcgi }};
    }
    {% endif %}}
}
